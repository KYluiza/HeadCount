# üöÄ Projeto Headcount Cycle

**Descri√ß√£o**  
Esse repo traz um projeto de headcount que simula todo o ciclo de contrata√ß√£o em empresas: da abertura da vaga, passando pelo c√°lculo de headcount da equipe, at√© o fechamento da vaga. T√° tudo rodando via Google Apps Script, integrado √† planilha dos gestores, mas sem expor tudo de uma vez ‚Äî assim cada √°rea consegue autonomia pra mexer no que precisa sem quebrar nada importante. üí™

---

## üìö O que tem aqui

- **Central de Proje√ß√£o multi-√°reas**: voc√™ passa o par√¢metro `area` (ex.: `sales`, `cs` etc.) e o script roda o c√°lculo de headcount e or√ßamento para aquela √°rea espec√≠fica.  
- **Separa√ß√£o de responsabilidades**: cada √°rea tem seus par√¢metros de linhas/colunas nas abas (HC Actual, Delta HC Pessoas, Delta HC Budget, Aprova√ß√£o: Novas Vagas, Budget p√≥s movimentos), evitando copy/paste desnecess√°rio.  
- **Prote√ß√£o de abas**: depois que roda a proje√ß√£o, as abas de resultados s√£o protegidas pra ningu√©m alterar manualmente. üîí  
- **Controle de or√ßamento x limite**: antes de abrir novas vagas, o script valida se o or√ßamento calculado t√° dentro dos limites definidos na planilha.  
- **Abertura autom√°tica de vagas**: com base na aba "Aprova√ß√£o: Novas Vagas", ele insere as novas vagas na aba ‚ÄúVagas Consolidadas‚Äù e marca as colunas L e M na planilha externa ‚ÄúVagas TBH‚Äù.  

---

## üóÇÔ∏è Estrutura do c√≥digo

O arquivo principal (`Code.gs` ou similar) traz as fun√ß√µes abaixo:

1. `doGet(e)`  
2. `getParametrosDaArea(area)`  
3. `calcularProjecaoCompleta(area)`  
4. `limparProjecao(area)`  
5. `protegerAba(sheet)`  
6. `calcularBudgetPosMovimentos(area)`  
7. `abrirVagas(area)`  

Cada fun√ß√£o roda um peda√ßo espec√≠fico do fluxo. A l√≥gica geral √©:

1. **Receber par√¢metro `area` via URL** (fun√ß√£o `doGet`) ‚Üí chama `calcularProjecaoCompleta`.  
2. **Buscar par√¢metros de linhas/colunas** (sheet names, ranges) de acordo com a √°rea (fun√ß√£o `getParametrosDaArea`).  
3. **Executar proje√ß√£o de headcount e or√ßamento** (fun√ß√£o `calcularProjecaoCompleta`):  
   - L√™ dados brutos de HC (sal√°rios, data de admiss√£o/sa√≠da, cargo, equipe).  
   - Calcula, m√™s a m√™s, quantas pessoas (‚ÄúHC‚Äù) est√£o ativas por cargo√óequipe e por equipe (colunas ‚ÄúDelta HC Pessoas‚Äù).  
   - Soma valores de sal√°rio m√™s a m√™s para cada cargo√óequipe e equipe (colunas ‚ÄúDelta HC Budget‚Äù).  
   - Exibe alertas de confirma√ß√£o e conclus√£o pro usu√°rio.  
4. **Limpar proje√ß√£o e proteger abas** (fun√ß√£o `limparProjecao`):  
   - Limpa todo o conte√∫do gerado nas abas ‚ÄúDelta HC Pessoas‚Äù, ‚ÄúDelta HC Budget‚Äù e ‚ÄúBudget p√≥s movimentos‚Äù.  
   - Protege as abas pra evitar edi√ß√£o manual.  
5. **Calcular budget p√≥s-movimentos** (fun√ß√£o `calcularBudgetPosMovimentos`):  
   - Puxa quantidades de novas vagas e sal√°rios m√©dios da aba ‚ÄúAprova√ß√£o: Novas Vagas‚Äù.  
   - Calcula o cumulativo de vagas por cargo√óequipe * sal√°rio m√©dio (movCargoEquipo).  
   - Adiciona ao or√ßamento base j√° existente em ‚ÄúDelta HC Budget‚Äù.  
   - Agrupa por equipe, soma ao or√ßamento base em ‚ÄúDelta HC Budget‚Äù e grava em ‚ÄúBudget p√≥s movimentos‚Äù.  
6. **Abrir vagas na planilha externa ‚ÄúVagas TBH‚Äù** (fun√ß√£o `abrirVagas`):  
   - Valida se o budget n√£o estourou os limites.  
   - Para cada quantidade de vaga aprovada, insere linha nova em ‚ÄúVagas Consolidadas‚Äù com informa√ß√£o de c√≥digo da vaga, data de solicita√ß√£o, equipe, cargo, m√™s de refer√™ncia e data de fechamento (hoje + 60 dias).  
   - Marca colunas L/M na planilha ‚ÄúVagas TBH‚Äù (externa) pra those vagas n√£o serem reaproveitadas.  

---

## üîç Explicando as fun√ß√µes (resumido)

### 1. `function doGet(e)`  
- **O que faz**: ponto de entrada quando voc√™ publica esse script como Web App.  
- **Par√¢metro**: `e.parameter.area` deve especificar a √°rea (ex.: `?area=sales`).  
- **Fluxo**:  
  1. Se n√£o vier `area`, devolve mensagem de erro.  
  2. Tenta chamar `calcularProjecaoCompleta(area.toLowerCase())`.  
  3. Retorna texto de sucesso (‚úÖ) ou erro (‚ùå) pro cliente.

### 2. `function getParametrosDaArea(area)`  
- **O que faz**: retorna um _objeto_ com todos os nomes de abas e √≠ndices de linhas/colunas espec√≠ficos pra cada √°rea.  
- **Pontos-chave**:  
  - Define vari√°veis como `primeiroCargoRow`, `ultimoCargoRow`, `primeiroEquipeRow`, `ultimoEquipeRow`.  
  - Mapeia nome das abas:  
    - `hcSheet`: aba ‚ÄúHC Actual Pessoas‚Äù (base de headcount).  
    - `deltaPess`: aba ‚ÄúDelta HC Pessoas‚Äù (c√°lculo de contagem).  
    - `deltaBudg`: aba ‚ÄúDelta HC Budget‚Äù (c√°lculo de sal√°rio).  
    - `aprovSheet`: aba ‚ÄúAprova√ß√£o: Novas Vagas‚Äù.  
    - `budgetPMSheet`: aba ‚ÄúBudget p√≥s movimentos‚Äù.  
    - `vagasConsSheet`: aba ‚ÄúVagas Consolidadas‚Äù.  
    - `TBH_ID`: ID da planilha externa ‚ÄúVagas TBH‚Äù.  
  - Retorna estrutura JSON-like com propriedades de ranges pra proje√ß√µes.  
- **Gambiarra**: caso a √°rea n√£o exista, pode lan√ßar erro (no trecho comentado).

### 3. `function calcularProjecaoCompleta(area)`  
- **O que faz**: roda todo o c√°lculo de headcount (contagem e or√ßamento).  
- **Detalhes do fluxo**:  
  1. Obt√©m par√¢metros via `getParametrosDaArea(area)`.  
  2. Pega refer√™ncias √†s abas `HC Actual Pessoas`, `Delta HC Pessoas`, `Delta HC Budget`.  
  3. Exibe um `ui.alert` (modal) perguntando se o usu√°rio j√° projetou todas as sa√≠das (sa√≠das = demiss√µes, desligamentos). Se o usu√°rio clicar ‚ÄúN√£o‚Äù, cancela tudo.  
  4. L√™ dados brutos:  
     - Coluna de sal√°rio ‚Üí transforma texto em n√∫mero (tira caracteres n√£o num√©ricos).  
     - Coluna de data de admiss√£o/sa√≠da ‚Üí converte em `{ y, m }` pra facilitar compara√ß√£o m√™s a m√™s.  
     - Coluna de cargo e equipe ‚Üí strings limpas com `.trim()`.  
  5. Junta cabe√ßalhos de meses (linha 3, colunas 5 a 28) ‚Üí converte em `{ y, m }`. Tem `mCount` meses no range.  
  6. **Proje√ß√£o por cargo√óequipe (contagem)**:  
     - Percorre cada par cargo√óequipe da aba ‚ÄúDelta HC Pessoas‚Äù (linhas `deltaStartRowP1` a `deltaEndRowP1`).  
     - Para cada m√™s, conta quantos funcion√°rios ativos naquela combina√ß√£o (admiss√£o ‚â§ m√™s e sa√≠da > m√™s).  
     - Grava matriz de contagem em ‚ÄúDelta HC Pessoas‚Äù (colunas E:AB).  
  7. **Proje√ß√£o por equipe (contagem)**:  
     - Mesma l√≥gica, mas apenas por equipe (linhas `deltaTeamsStartP2` por `deltaTeamsCountP2`). Grava no range correspondente.  
  8. **Proje√ß√£o por cargo√óequipe (sal√°rio)**:  
     - Igual ao contagem, por√©m soma `sal√°rios[j]` ao inv√©s de contar. Grava em ‚ÄúDelta HC Budget‚Äù.  
  9. **Proje√ß√£o por equipe (sal√°rio)**:  
     - Mesma ideia por equipe, soma sal√°rios, grava ‚ÄúDelta HC Budget‚Äù.  
  10. Exibe `ui.alert` de ‚Äúproje√ß√£o conclu√≠da‚Äù e orienta o usu√°rio.  

### 4. `function limparProjecao(area)`  
- **O que faz**: limpa todo resultado das proje√ß√µes anteriores.  
- **Fluxo**:  
  1. Pega par√¢metros com `getParametrosDaArea(area)`.  
  2. L√™ quantos meses h√° na linha de cabe√ßalho (exatamente a mesma l√≥gica pra descobrir `mCount`).  
  3. Usa `.clearContent()` pra apagar:  
     - Faixa de contagem e sal√°rio em ‚ÄúDelta HC Pessoas‚Äù.  
     - Faixa de contagem e sal√°rio em ‚ÄúDelta HC Budget‚Äù.  
     - Faixa de budget em ‚ÄúBudget p√≥s movimentos‚Äù.  
  4. Chama `protegerAba(sheet)` nas abas que geram resultado, pra proteger contra edi√ß√£o manual.  
  5. Exibe alerta de ‚Äúlimpeza conclu√≠da e abas protegidas‚Äù.  

### 5. `function protegerAba(sheet)`  
- **O que faz**: protege uma aba inteira da planilha contra edi√ß√£o.  
- **Detalhes**:  
  1. Remove prote√ß√µes antigas (`sheet.getProtections(...)`).  
  2. Aplica prote√ß√£o full (`sheet.protect()`) ‚Üí como ‚ÄúProtegido pelo script‚Äù.  
  3. Remove todos editores (`protection.removeEditors(...)`).  
  4. Se o dom√≠nio puder editar, desabilita (`protection.setDomainEdit(false)`).

### 6. `function calcularBudgetPosMovimentos(area)`  
- **O que faz**: atualiza a aba ‚ÄúBudget p√≥s movimentos‚Äù a partir dos dados de ‚ÄúAprova√ß√£o: Novas Vagas‚Äù.  
- **Fluxo**:  
  1. Obt√©m par√¢metros via `getParametrosDaArea(area)`.  
  2. Pega refer√™ncias √†s abas ‚ÄúAprova√ß√£o: Novas Vagas‚Äù, ‚ÄúDelta HC Budget‚Äù e ‚ÄúBudget p√≥s movimentos‚Äù. Se alguma n√£o existir, alerta e sai.  
  3. L√™ cabe√ßalho de meses (E3:AB3) para determinar `mCount`.  
  4. L√™:  
     - Equipe (coluna B), Cargo (coluna C), Sal√°rio m√©dio (coluna D) em ‚ÄúAprova√ß√£o: Novas Vagas‚Äù ‚Üí converte sal√°rios textuais em n√∫mero.  
     - Quantidades aprovadas (E35:AB213, ou linhas definidas para √°rea) ‚Üí matriz `qtdsAprov`.  
  5. L√™ base do ‚ÄúDelta HC Budget‚Äù (E35:AB213 e E5:AB19) ‚Üí `baseDeltaCargoEquipe`, `baseDeltaEquipe`.  
  6. Gera `movCargoEquipo`: cumulativo de vagas √ó sal√°rio m√©dio para cada linha de cargo√óequipe ‚Üí array `[nCargoRows][mCount]`.  
  7. Soma `movCargoEquipo` com `baseDeltaCargoEquipe` ‚Üí gera `updatedBudgetCargoEquipe`. Grava em ‚ÄúBudget p√≥s movimentos‚Äù (E35:AB213).  
  8. Agrupa `movCargoEquipo` por equipe usando `equipesDeltaEquipes` e `equipesAprov_raw`, soma a `baseDeltaEquipe` ‚Üí `updatedBudgetEquipe`. Grava em E5:AB19 de ‚ÄúBudget p√≥s movimentos‚Äù.  

### 7. `function abrirVagas(area)`  
- **O que faz**: insere novas vagas baseadas na aprova√ß√£o e atualiza a planilha externa ‚ÄúVagas TBH‚Äù.  
- **Fluxo**:  
  1. Pega par√¢metros via `getParametrosDaArea(area)`.  
  2. Valida exist√™ncia das abas internas (`HC`, `Budget p√≥s movimentos`, `Aprova√ß√£o: Novas Vagas`, `Vagas Consolidadas`) e externa (‚ÄúVagas TBH‚Äù). Se faltar, alerta e sai.  
  3. **Valida√ß√£o de or√ßamento x limite**:  
     - Pega valor limite de HC em `HC Actual Pessoas!N4`.  
     - L√™ valores do or√ßamento atual (E4:AB4).  
     - Se algum valor ‚â• limite, pergunta se quer prosseguir.  
  4. Prepara vari√°veis da aba ‚ÄúAprova√ß√£o: Novas Vagas‚Äù:  
     - `equipesAprov`, `cargosAprov`, `qtdsAprov` (matriz de quantidades).  
     - `mesesRef` (cabe√ßalho de meses, 3¬™ linha).  
  5. Prepara dados da planilha externa ‚ÄúVagas TBH‚Äù:  
     - L√™ todos `codesTBH` (c√≥digo das vagas, coluna B).  
     - L√™ colunas L/M pra saber quais linhas est√£o livres (sem vaga enviada).  
     - Fun√ß√£o interna `findNextFree()` busca pr√≥ximo √≠ndice livre em L/M.  
  6. **Loop de inser√ß√£o de vagas**:  
     - Pra cada linha de ‚ÄúAprova√ß√£o: Novas Vagas‚Äù (cargo√óequipe) e pra cada m√™s (colunas E:AB), se `qtd > 0`:  
       - Pra cada unidade da `qtd`, faz:  
         1. Calcula `nextRow` em ‚ÄúVagas Consolidadas‚Äù (√∫ltima linha + 1).  
         2. Acha `idx` livre em TBH (chama `findNextFree()`). Se n√£o achar, alerta e sai.  
         3. Preenche ‚ÄúVagas Consolidadas‚Äù nas colunas:  
            - A: `codigoVaga` (c√≥digo da TBH).  
            - B: `dataHoje` (data da solicita√ß√£o).  
            - C: `equipe`.  
            - D: `cargo`.  
            - E: `mes` (m√™s de refer√™ncia).  
            - F: `dataFech` (hoje + 60 dias).  
         4. Atualiza arrays `colL[idx] = equipe` e `colM[idx] = cargo` para n√£o reutilizar aquela vaga. E incrementa `nextFreeTBH`.  
  7. Grava as atualiza√ß√µes de `colL` e `colM` de volta na planilha ‚ÄúVagas TBH‚Äù (linhas 2..n).  
  8. Exibe alerta de ‚Äúprocessamento conclu√≠do‚Äù.  

---

## ‚öôÔ∏è Como usar

1. **Publicar como Web App**  
   - Em ‚ÄúEditor de Script‚Äù (Apps Script), clique em **Publicar > Implantar como aplicativo da Web**.  
   - Defina ‚ÄúExecutar o app como‚Äù ‚Üí seu usu√°rio.  
   - ‚ÄúQuem tem acesso‚Äù ‚Üí **Qualquer um, mesmo an√¥nimo** (ou restrito ao dom√≠nio, conforme a necessidade).  
   - Copie a URL de implanta√ß√£o, que ser√° algo como:  
     ```
     https://script.google.com/macros/s/AKfycbx‚Ä¶/exec
     ```  
   - Para rodar proje√ß√£o de uma √°rea (ex.: sales), acesse no navegador:  
     ```
     https://script.google.com/macros/s/‚Ä¶/exec?area=sales
     ```
   - A resposta ser√° um texto simples:  
     - `‚úÖ Proje√ß√£o realizada para a √°rea sales`  
     - Ou `‚ùå Erro ao executar proje√ß√£o: ...`

2. **Rodar manual via menu**  
   - Ao abrir a planilha, um menu ‚ÄúüßÆ Gest√£o‚Äù aparece (func√£o `onOpen`).  
   - Clique em **üßÆ Gest√£o > ‚ú® Proje√ß√£o inicial Sales** para rodar apenas a proje√ß√£o de budget p√≥s movimentos (fun√ß√£o `calcularBudgetPosMovimentos('sales')`).  
   - Outro menu pode ser criado pra rodar projeto completo ou limpar proje√ß√£o, conforme desejar.

3. **Configurar abas e ranges**  
   - Garanta que as abas tenham exatamente os nomes definidos em `getParametrosDaArea`, caso contr√°rio o script n√£o vai achar e vai quebrar.  
   - Alinhe as colunas:  
     - **HC Actual Pessoas**: Col A = sal√°rio, Col C = data de admiss√£o (admission date), Col E = cargo, Col G = equipe, Col J = data de sa√≠da (exit date).  
     - **Delta HC Pessoas & Delta HC Budget**: meses em E3:AB3, equipes e cargos nos ranges definidos (linhas 35‚Äì213, equipes 5‚Äì19 para Sales).  
     - **Aprova√ß√£o: Novas Vagas**: colunas B/C/D para equipe/cargo/sal√°rio m√©dio a partir da linha 35, meses em E3:AB3 tamb√©m.  
     - **Budget p√≥s movimentos**: planilha que recebe o resultado final do budget (E5:AB19 para equipes, E35:AB213 para cargo√óequipe).  
     - **Vagas Consolidadas**: planilha interna que recebe c√≥digo da vaga, data, equipe, cargo, m√™s e data de fechamento.  
     - **Vagas TBH** (planilha externa): Coluna B = c√≥digo da vaga, Col L/M = equipe e cargo marcados quando a vaga for usada.

4. **Permiss√µes**  
   - O script precisa de acesso a:  
     - Planilha atual (o container).  
     - Planilha externa ‚ÄúVagas TBH‚Äù (via `openById`).  
     - Mensagens UI (alertas e confirma√ß√µes).  
   - Quando publicar/autorizar, permita leitura e escrita nas planilhas.

---

## ü§ì Dicas e observa√ß√µes

- **Autonomia e prote√ß√£o**: como conversamos, o c√≥digo n√£o exp√µe todas as formulas nem ranges diretamente nos Apps Script dos gestores ‚Äî tudo est√° parametrizado em `getParametrosDaArea`. Se algu√©m derrubar uma linha de par√¢metro, o script quebra, mas n√£o afeta suas f√≥rmulas cr√≠ticas.  
- **Escalabilidade multi-√°reas**: quer adicionar outra √°rea (ex.: `cs`)? Basta descomentar a se√ß√£o `else if (area === "cs")` em `getParametrosDaArea` e ajustar as vari√°veis de linhas (primeiroCargoRow, √∫ltimoCargoRow, etc.). F√°cil de estender.  
- **Casos de erro**: o script j√° avisa via `ui.alert` se faltar alguma aba ou se o or√ßamento estourou o limite (voc√™ escolhe prosseguir ou abortar).  
- **Prote√ß√£o de abas**: a fun√ß√£o `protegerAba` bloqueia edi√ß√£o manual ‚Äî se precisar ‚Äúdesproteger‚Äù manualmente, v√° em ‚ÄúProte√ß√£o de planilha‚Äù nas configura√ß√µes da planilha e remova a prote√ß√£o ou execute um script que remova prote√ß√µes (cuidado!).  

---

## ‚úèÔ∏è Contribui√ß√£o

1. Fa√ßa um **fork** desse reposit√≥rio.  
2. Crie uma **branch** nova: `git checkout -b minha-area-extra`.  
3. Implemente suas altera√ß√µes (ex.: adicionando nova √°rea, ajustando ranges).  
4. **Commit** e envie pra sua branch:  
   ```bash
   git commit -m "feat: adiciona √°rea CS"
   git push origin minha-area-extra
